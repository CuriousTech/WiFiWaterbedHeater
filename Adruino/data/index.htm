<!DOCTYPE html><html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>WiFi Waterbed Heater</title>
<style type="text/css">
table,input{
border-radius: 5px;
box-shadow: 2px 2px 12px #000000;
background-image: -moz-linear-gradient(top, #dfffff, #5050ff);
background-image: -ms-linear-gradient(top, #dfffff, #5050ff);
background-image: -o-linear-gradient(top, #dfffff, #5050ff);
background-image: -webkit-linear-gradient(top, #dfffff, #5050ff);
background-image: linear-gradient(top, #dfffff, #5050ff);
background-clip: padding-box;
}
body{width:320px;display:block;margin-left:auto;margin-right:auto;text-align:right;font-family: Arial, Helvetica, sans-serif;}}
</style>
<script type="text/javascript" src="data"></script>
<script type="text/javascript">
a=document.all
oledon=0
avg=1
cnt=1
function openSocket(){
ws=new WebSocket("ws://"+window.location.host+"/ws")
ws.onopen=function(evt) { }
ws.onclose=function(evt) { alert("Connection closed."); }
ws.onmessage=function(evt) {
 lines=evt.data.split(';')
 event=lines[0]
 data=lines[1]
 if(event=='state')
 {
  d=JSON.parse(data)
  dt=new Date(d.t*1000)
  a.time.innerHTML=dt.toLocaleTimeString()
  waterTemp=d.waterTemp.toFixed(1)
  a.temp.innerHTML=waterTemp+'&degF'
  a.on.innerHTML=">"+d.hiTemp.toFixed(1)+"&degF "+(d.on?"<font color='red'><b>ON</b></font>":"OFF")
  a.rt.innerHTML=d.temp.toFixed(1)+'&degF'
  a.rh.innerHTML=d.rh.toFixed(1)+'%'
  a.tc.innerHTML='$'+d.tc.toFixed(2)
 }
 else if(event=='set')
 {
  d=JSON.parse(data)
  a.vt.value=d.vt.toFixed(1)
  oledon=d.o
  a.OLED.value=oledon?'ON ':'OFF'
  avg=d.avg
  a.AVG.value=avg?'ON ':'OFF'
  a.tz.value=d.tz
  a.K.value=d.ppkwh/10000
  a.vo.value=d.vo?'ON ':'OFF'
  cnt=d.cnt
  idx=d.idx
  for(i=0;i<8;i++){
   item=document.getElementById('r'+i); item.setAttribute('style',i<cnt?'':'display:none')
   if(i==idx) item.setAttribute('style','background-color:red')
   document.getElementById('N'+i).value=d.item[i][0]
   document.getElementById('S'+i).value=d.item[i][1]
   document.getElementById('T'+i).value=d.item[i][2]
   document.getElementById('H'+i).value=d.item[i][3]
  }
  a.inc.value=Math.min(8,cnt+1)
  a.dec.value=Math.max(1,cnt-1)
  a.tc2.innerHTML=d.tc2
  a.m.innerHTML=d.m+':'
  draw()
 }
 else if(event=='alert')
 {
  alert(data)
 }
}
}
function setVar(varName, value)
{
 ws.send('cmd;{"key":"'+a.myKey.value+'","'+varName+'":'+value+'}')
}
function oled(){oledon=!oledon
setVar('oled',oledon)
a.OLED.value=oledon?'ON ':'OFF'
}
function setavg(){avg=!avg
setVar('avg',avg)
a.AVG.value=avg?'ON ':'OFF'
draw()
}
function setTZ(){
setVar('TZ',a.tz.value)}
function setTemp(n){
setVar('tadj',n)
item=document.getElementById('T'+idx)
item.value=+item.value+n
}
function setVaca(){
setVar('vacatemp',a.vt.value)
setVar('vaca',(a.vo.value=='OFF')?true:false)
a.vo.value=(a.vo.value=='OFF')?'ON ':'OFF'
}
function setCnt(n){
cnt+=n
setVar('cnt',cnt)
}
function setPPK(){
setVar('ppkwh',(a.K.value*10000).toFixed())
}
function setEntry(n){
name=document.getElementById('N'+n).value
tm=document.getElementById('S'+n).value
tp=document.getElementById('T'+n).value
th=document.getElementById('H'+n).value
ws.send('cmd;{"key":"'+a.myKey.value+'","N'+n+'":"'+name+'","S'+n+'":"'+tm+'","T'+n+'":"'+tp+'","H'+n+'":"'+th+'"}')
}

var x,y,llh=0,llh2=0
function draw(){
try {
  c2 = document.getElementById('canva')
  ctx = c2.getContext("2d")
  ctx.fillStyle = "#66F"
  ctx.fillRect(0,0,c2.width,c2.height)//bg
  ctx.strokeStyle = "#666"
  step = c2.width/24
  ctx.beginPath()
  for (x = step; x < c2.width; x += step) {  // vertical lines
    ctx.moveTo(x, 0)
    ctx.lineTo(x, c2.height)
  }
  ctx.stroke()

  ctx.font = "bold 11px sans-serif"

  ctx.fillStyle = "#111" // temps
  step=c2.width/cnt
  y = c2.height
  ctx.fillText(12, c2.width/2, y)//hrs
  ctx.fillText(6, c2.width/4, y)
  ctx.fillText(18, c2.width/2+c2.width/4, y)

  ctx.strokeStyle = "#000"
  if(avg)
  {
	ctx.beginPath()
	m=c2.width-s2x(d.item[cnt-1][1])
	r=m+s2x(d.item[0][1])
	tt1=tween(+d.item[cnt-1][2],+d.item[0][2],m,r) // get y of midnight
	th1=tween(+d.item[cnt-1][2]-d.item[cnt-1][3],+d.item[0][2]-d.item[0][3],m,r) // thresh
	ctx.moveTo(0, t2y(tt1)) //1st point
	for(i=0;i<cnt;i++){
		x = s2x(d.item[i][1]) // time to x
	  	linePos(+d.item[i][2])
		ctx.fillText(d.item[i][2],x,t2y(+d.item[i][2])-4)
	}
	i--;
  	x = c2.width
  	linePos(tt1) // temp at mid
  	linePos(th1) // thresh tween
	for(;i>=0;i--){
		x = s2x(d.item[i][1])
	  	linePos(d.item[i][2]-d.item[i][3])
	}
	x=0
  	linePos(th1) // thresh at midnight
	ctx.closePath()
	ctx.fillStyle = "#666"
	ctx.fill()
  }
  else
  {
	for(i=0;i<cnt;i++)
	{
		x=s2x(d.item[i][1])
		y=t2y(d.item[i][2]) // temp
		y2=t2y(d.item[i][2]-d.item[i][3])-y // thresh
		if(i==cnt-1) x2=c2.width-x
		else x2=s2x(d.item[i+1][1])-x
		ctx.fillStyle = "#666"
		ctx.fillRect(x, y, x2, y2)
		ctx.fillStyle = "#000"
		ctx.fillText(d.item[i][2], x, y-2)
	}
	x0 = s2x(d.item[0][1])
	ctx.fillStyle = "#666"
	ctx.fillRect(0, y, x0, y2) // rollover midnight
  }
  x = s2x((new Date()).toTimeString()) // now
  ctx.beginPath()
  y = t2y(waterTemp)
  ctx.moveTo(x,y)
  ctx.lineTo(x-4,y+6)
  ctx.lineTo(x+4,y+6)
  ctx.closePath()
  ctx.fillStyle="#0f0"
  ctx.fill()
  ctx.stroke()

  ctx.beginPath()
  for(i=0;i<tdata.length;i++) // hist data
  {
	if(tdata[i].t==0) continue;
	x=s2x(tdata[i].tm)
	y=t2y(tdata[i].t)
	ctx.lineTo(x,y)
	ctx.stroke()
	ctx.beginPath()
	ctx.moveTo(x,y)
	switch(tdata[i].s)
	{
		case 0: ctx.strokeStyle="#00F";break
		case 1: ctx.strokeStyle="#F00";break
		case 2: ctx.beginPath();break
	}
  }
}catch(err){}
}
function linePos(t)
{
  ctx.lineTo(x,t2y(t))
}
function s2x(s)
{
  tm = s.split(':')
  return (tm[0]*60 + (+tm[1]))*c2.width/1440
}
function t2y(t)
{
  return c2.height-((t-70)/20*c2.height)
}
function tween(t1, t2, m, r)
{
	t=(t2-t1)*(m*100/r)/100
	t+=t1
	return t.toFixed(1)
}
</script>
</head>
<body bgcolor="silver" onload="{
key=localStorage.getItem('key')
if(key!=null) document.getElementById('myKey').value=key
openSocket()
}">
<h3>WiFi Waterbed Heater</h3>
<table align="right">
<tr><td align="center" colspan=2><div id="time"></div></td><td><div id="temp"></div> </td><td align="center"><div id="on"></div></td></tr>
<tr><td align="center" colspan=2>Bedroom: </td><td><div id="rt"></div></td><td align="left"><div id="rh"></div> </td></tr>
<tr><td colspan=2>TZ <input id='tz' type=text size=2 value='-5'><input value="Set" type='button' onclick="{setTZ()}"></td><td colspan=2>Display:<input type="button" value="ON " id="OLED" onClick="{oled()}"></td></tr>
<tr><td colspan=2>Vaca:<input id='vt' type=text size=2 value='-10'><input type='button' id='vo' onclick="{setVaca()}"></td>
<td colspan=2>Average:<input type="button" value="OFF" id="AVG" onClick="{setavg()}"></td></tr>
<tr><td colspan=2>Schedule <input id='inc' type='button' onclick="{setCnt(1)}"><br/>
Count <input id='dec' type='button' onclick="{setCnt(-1)}"}></td>
<td colspan=2>Temp <input type='button' value='Up' onclick="{setTemp(1)}"><br/>
Adjust <input type='button' value='Dn' onclick="{setTemp(-1)}"></td></tr>
<tr><td align="left">Name</td><td align="left">Time</td><td align="left">Temp</td><td width="99px" align="left">Threshold</td></tr>
<tr><td colspan=4 id='r0' style="display:none"><input id=N0 type=text size=6> <input id=S0 type=text size=3> <input id=T0 type=text size=3> <input id=H0 type=text size=2> <input value="Set" type='button' onclick="{setEntry(0)}"></td></tr>
<tr><td colspan=4 id='r1' style="display:none"><input id=N1 type=text size=6> <input id=S1 type=text size=3> <input id=T1 type=text size=3> <input id=H1 type=text size=2> <input value="Set" type='button' onclick="{setEntry(1)}"></td></tr>
<tr><td colspan=4 id='r2' style="display:none"><input id=N2 type=text size=6> <input id=S2 type=text size=3> <input id=T2 type=text size=3> <input id=H2 type=text size=2> <input value="Set" type='button' onclick="{setEntry(2)}"></td></tr>
<tr><td colspan=4 id='r3' style="display:none"><input id=N3 type=text size=6> <input id=S3 type=text size=3> <input id=T3 type=text size=3> <input id=H3 type=text size=2> <input value="Set" type='button' onclick="{setEntry(3)}"></td></tr>
<tr><td colspan=4 id='r4' style="display:none"><input id=N4 type=text size=6> <input id=S4 type=text size=3> <input id=T4 type=text size=3> <input id=H4 type=text size=2> <input value="Set" type='button' onclick="{setEntry(4)}"></td></tr>
<tr><td colspan=4 id='r5' style="display:none"><input id=N5 type=text size=6> <input id=S5 type=text size=3> <input id=T5 type=text size=3> <input id=H5 type=text size=2> <input value="Set" type='button' onclick="{setEntry(5)}"></td></tr>
<tr><td colspan=4 id='r6' style="display:none"><input id=N6 type=text size=6> <input id=S6 type=text size=3> <input id=T6 type=text size=3> <input id=H6 type=text size=2> <input value="Set" type='button' onclick="{setEntry(6)}"></td></tr>
<tr><td colspan=4 id='r7' style="display:none"><input id=N7 type=text size=6> <input id=S7 type=text size=3> <input id=T7 type=text size=3> <input id=H7 type=text size=2> <input value="Set" type='button' onclick="{setEntry(7)}"></td></tr>
<tr><td colspan=4><canvas id="canva" width="288" height="100" style="border:1px dotted;float:left" onclick="draw()"></canvas></td></tr>
<tr height=32><td id='tc2'></td><td id='m'></td><td><div id='tc'>$0.00</div></td><td>$<input id='K' type=text size=2 value='0.1457'><input value="Set" type='button' onclick="{setPPK()}"></td></tr>
<tr><td colspan=2></td><td colspan=2><input id="myKey" name="key" type=text size=40 placeholder="password" style="width: 90px"><input type="button" value="Save" onClick="{localStorage.setItem('key', key = document.all.myKey.value)}"></td></tr>
</table>
</body>
</html>
